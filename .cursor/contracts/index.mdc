# .cursor/contracts Index

Work contracts — session-independent execution plans with state, tasks, and completion criteria.

## Mock implementation & wiring (BDD/TDD, red–green–blue)

Execute **in order**; each contract depends on the previous.

| Order | Contract | Goal |
|-------|----------|------|
| **1** | `mock-pre-investigation.md` | Mock fetch + save envelope to store (fixture; no RP). **Complete.** |
| **2** | `mock-investigation.md` | Mock analyze: read from store → cases + artifact (no real AI). **Complete.** |
| **3** | `mock-post-investigation.md` | Mock push: read artifact → defect type + RCA to mock (no RP/Jira). **Complete.** |
| **4** | `mock-wiring.md` | Wire 1→2→3: one runnable flow (fetch → analyze → push) with mocks. **Complete.** |

**Execution order:** 1 → 2 → 3 → 4. Complete all tasks (Red → Green → Blue → Validate) in contract 1 before starting 2; same for 2→3, 3→4.

## PoC implementation (from assessment)

Contracts created from the PoC assessment. Dependencies: complete **rp-api-completion** before **rp-fetch** and **rp-push**; complete **storage-adapter**, **context-workspace**, **artifact-schema** before **asterisk-cli**; complete **asterisk-cli** and **prompts** before **cursor-handoff**. Others can run in parallel where no dep is listed.

| Contract | Goal | Depends on |
|----------|------|------------|
| `rp-api-completion.md` | Finish RP API research; document launch, test-item, defect-type in FSC (`notes/rp-api-usage.mdc`). | — |
| `storage-adapter.md` | SQLite + Store facade (cases, RCAs); per-workspace DB; wire into flow. | — |
| `context-workspace.md` | Load workspace from FS (YAML/JSON/TOML); pass into analyze. | — |
| `artifact-schema.md` | Add `rca_message` to artifact; document schema in FSC. | — |
| `prompts.md` | Prompt templates in `.cursor/prompts/`; params doc in `docs/prompts.mdc`. | — |
| `rp-fetch.md` | Real fetch from RP (launch by ID); produce envelope; persist to store/path. | rp-api-completion |
| `rp-push.md` | Real push to RP (defect-type update); read artifact, call RP API. | rp-api-completion |
| `asterisk-cli.md` | `asterisk` binary with `analyze` and `push -f`; envelope, workspace, storage, artifact. | storage-adapter, context-workspace, artifact-schema |
| `cursor-handoff.md` | Minimal `asterisk --cursor`: prompt output, save/ingest, document flow. | asterisk-cli, prompts |

## Prompt system (design)

| Contract | Goal | Depends on |
|----------|------|------------|
| `prompt-families.md` | Design prompt family taxonomy, pipelines (with loops), and routing heuristics for layered investigation. | prompts, storage-adapter, context-workspace |

## Data model (design)

| Contract | Goal | Depends on |
|----------|------|------------|
| `investigation-context.md` | Two-tier data model: investigation-scoped execution tree + global cross-version knowledge (symptoms, RCAs) with temporal context. | storage-adapter, prompt-families |

## PoC v2 implementation (from design contracts)

Build order: complete **storage-adapter-v2** before **prompt-orchestrator** (orchestrator depends on v2 Store). Design contracts (prompt-families, investigation-context) must be finalized before starting these. **Real calibration (Scenario B)** is the absolute last step — only after all contracts are complete, the code is refactored/decoupled, and mock calibration (Scenario A) passes. See `rules/asterisk-development.mdc` § Calibration ordering.

| Contract | Goal | Depends on |
|----------|------|------------|
| `storage-adapter-v2.md` | Migrate Store interface and SQLite schema from v1 (flat) to v2 (two-tier: execution tree + symptoms + RCAs). **Complete.** | storage-adapter (v1 complete), investigation-context (design) |
| `prompt-orchestrator.md` | Implement F0–F6 pipeline engine: heuristic engine, artifact I/O, per-case state, template filler, pipeline runner, CLI integration. **Complete.** | storage-adapter-v2, prompt-families (design), prompts, cursor-handoff |
| `e2e-calibration.md` | Closed-world E2E test: 20 instrumented metrics. **Mock A (ptp-mock 12 cases): 20/20. Mock B (daemon-mock 8 cases): 20/20. Real (ptp-real 8 cases): 20/20. All stub-passing.** | storage-adapter-v2, prompt-orchestrator |

## RP adapter v2 (quality upgrade)

| Contract | Goal | Depends on |
|----------|------|------------|
| `rp-adapter-v2.md` | Unify `rpfetch` + `rppush` into single `internal/rp` package. Scope-based client (`Client → ProjectScope → LaunchScope → ItemScope`), functional options, `APIError` type with predicates, `context.Context`, structured logging, enriched `FailureItem`, bulk defect update. Patterns adapted from `report-portal-cli` (read-only reference, no module dependency). | rp-fetch (complete), rp-push (complete), rp-api-completion (complete) |

## Dispatcher (transport layer)

| Contract | Goal | Depends on |
|----------|------|------------|
| `fs-dispatcher.md` | Extract `Dispatcher` interface (Strategy pattern) from `CursorAdapter`; implement `StdinDispatcher` (current stdin) + `FileDispatcher` (signal file polling for auto-mode); wire `--dispatch` CLI flag. Future: HTTP, MCP, Harness dispatchers via same interface. | e2e-calibration (CursorAdapter exists), prompt-orchestrator |

## Cursor skill (agent-side integration)

| Contract | Goal | Depends on |
|----------|------|------------|
| `cursor-skill.md` | Create `.cursor/skills/asterisk-investigate/` — Cursor agent skill that responds to FileDispatcher signal files, reads prompts, produces F0–F6 JSON artifacts, and writes them back. Dual mode: calibration (blind, scored against ground truth) and investigation (free, real analysis). 4 files: SKILL.md, signal-protocol.md, artifact-schemas.md, examples.md. | fs-dispatcher (signal protocol), e2e-calibration (scoring), prompt-orchestrator (pipeline/schemas) |

## Calibration victory (wet calibration)

| Contract | Goal | Depends on |
|----------|------|------------|
| `wet-calibration.md` | Formalize dry/wet calibration taxonomy, 28 per-case Test Cards across 3 scenarios, and an iterative "victory loop" (run wet → diagnose → tune → dry check → repeat) until all scenarios pass 20/20 metrics with `--adapter=cursor`. | fs-dispatcher (auto dispatch), cursor-skill (agent responds to signals), e2e-calibration (dry baseline) |

## Real calibration ingest (data pipeline)

|| Contract | Goal | Depends on |
||----------|------|------------|
|| `real-calibration-ingest.md` | Ingest real CI data (`.maildump/` email dump + CI results spreadsheet) into calibration `Scenario` definitions with annotated ground truth, producing ≤30 real-world test cases. Phases: email triage → CI results parse → case selection → ground truth annotation → scenario generation. | e2e-calibration (scenario format), wet-calibration (calibration loop) |

## Calibration improvement loop (M19: 0.58 → 0.95+)

Execute **in order**; each contract depends on the previous. Gate: the preceding contract's M19 target must be met before starting the next.

| Order | Contract | Goal | Entry M19 | Exit M19 |
|-------|----------|------|-----------|----------|
| **1** | `calibration-bugfix-r5.md` | Fix 5 known blocking bugs (H15 dup, skip path, repo names, JSON error, component ID). | 0.58 | >= 0.65 |
| **2** | `responder-classification-v2.md` | Systematic classification overhaul: ground-truth test fixture, scored multi-signal classifier, token optimization. | >= 0.65 | >= 0.80 |
| **3** | `calibration-victory.md` | Evidence quality, RCA relevance, convergence calibration, cross-scenario regression. All 20/20 metrics. | >= 0.80 | >= 0.95 |
| **4** | `parallel-investigation.md` | Parallel case processing: fan-out F0-F1, symptom clustering, on-demand RCA agents, token ceiling. Future phase. | >= 0.95 | >= 0.95 + 3x speedup |

## Token performance tracking (cost observability)

| Contract | Goal | Depends on |
|----------|------|------------|
| `token-perf-tracking.md` | Instrument real token usage per step/case/run; compute cost per calibration run; upgrade M18 from estimate to actual measurement. | e2e-calibration (M18 metric), fs-dispatcher (instrument dispatch) |

## Cleanup lifecycle (operational hygiene)

|| Contract | Goal | Depends on |
||----------|------|------------|
|| `cleanup-lifecycle.md` | Automated pre-run cleanup (`--clean`), mock-calibration-agent subprocess management (`--responder=auto`), `.tmp` orphan fix, post-run signal finalization. No manual cleanup between wet calibration iterations. | fs-dispatcher, wet-calibration |

## Directories

## Files
- `index.mdc` — index for this directory.
- `_TEMPLATE.md` — contract template; copy to create new contracts (do not edit template).
- `prompt-families.md` — **Prompt families:** taxonomy (F0–F6), pipelines, loops, routing heuristics; replaces single-shot rca.md with layered system.
- `investigation-context.md` — **Investigation context data model:** two-tier (investigation-scoped tree + global knowledge); symptoms, RCAs, temporal context; schema v2; prompt injection mapping.
- `artifact-schema.md` — **Artifact schema:** add rca_message; document in FSC; align with pre-dev.
- `asterisk-cli.md` — **asterisk CLI:** analyze and push -f subcommands; envelope, workspace, storage.
- `context-workspace.md` — **Context workspace:** load from FS (YAML/JSON/TOML); use in analyze.
- `cursor-handoff.md` — **Cursor handoff:** minimal asterisk --cursor; prompt output; save/ingest; document flow.
- `go-testing-preferences.md` — **Go testing preferences:** when to use standard library vs framework; rules in `rules/go-testing.mdc`.
- `mock-pre-investigation.md` — **Mock Pre-investigation:** fetch (stub) + save envelope to DB/workspace; BDD/TDD, red-green-blue.
- `mock-investigation.md` — **Mock Investigation:** analyze from store → cases + artifact; BDD/TDD, red-green-blue.
- `mock-post-investigation.md` — **Mock Post-investigation:** push artifact to mock RP/RCA store; BDD/TDD, red-green-blue.
- `mock-wiring.md` — **Mock Wiring:** wire pre-inv → investigation → post-inv into one flow; BDD/TDD, red-green-blue.
- `pre-dev-questions.md` — Pre-development questions: make question bank (envelope, storage, Cursor, artifact, RP, prompts, lifecycle); answer or defer each; record outcomes before starting implementation.
- `prompts.md` — **Prompts:** templates in .cursor/prompts/; params in docs/prompts.mdc.
- `rp-api-completion.md` — **RP API completion:** finish research; document launch, test-item, defect-type; FSC doc.
- `rp-api-research.md` — **RP API deep research (5.11):** learn to interact with API at locked version; document endpoints and usage for FSC; add rules if needed; example launch 33195.
- `rp-fetch.md` — **Real fetch from RP:** launch by ID; produce envelope; persist.
- `rp-push.md` — **Real push to RP:** defect-type update from artifact.
- `storage-adapter.md` — **Storage adapter:** SQLite + Store facade; per-workspace DB.
- `storage-adapter-v2.md` — **Storage adapter v2:** Migrate Store to two-tier schema (investigation tree + symptoms + RCAs); v1→v2 migration; expanded CRUD.
- `prompt-orchestrator.md` — **Prompt orchestrator:** F0–F6 pipeline engine; heuristic engine, artifact I/O, per-case state, template filler, CLI integration.
- `e2e-calibration.md` — **E2E calibration test:** closed-world scenario with synthetic ground truth, fake RP API, synthetic workspace (5 repos + red herring), blindfolded investigation, 20 metrics (structured, workspace, evidence, semantic, pipeline, aggregate), stub + cursor adapters.
- `fs-dispatcher.md` — **FS Dispatcher:** Strategy-pattern transport layer for CursorAdapter; StdinDispatcher (extract current interactive), FileDispatcher (auto signal-file polling); `--dispatch` CLI flag; extensible to HTTP/MCP/Harness.
- `rp-adapter-v2.md` — **RP adapter v2:** Unify rpfetch + rppush into `internal/rp`; scope-based client, functional options, APIError + predicates, context.Context, enriched FailureItem, bulk defect update. Patterns from `report-portal-cli` (read-only reference).
- `cursor-skill.md` — **Cursor skill:** `asterisk-investigate` agent skill; responds to FileDispatcher signals, reads F0–F6 prompts, produces structured JSON artifacts; calibration (blind) and investigation (free) modes; 4 files (SKILL.md, signal-protocol, artifact-schemas, examples).
- `wet-calibration.md` — **Wet calibration victory:** Dry/wet taxonomy, 28 Test Cards (ptp-mock 12 + daemon-mock 8 + ptp-real 8), victory loop (run wet → diagnose → tune → dry check → repeat), iteration log. Target: all 3 scenarios 20/20 with `--adapter=cursor --dispatch=file`.
- `cleanup-lifecycle.md` — **Cleanup lifecycle:** Automated pre-run cleanup, mock-calibration-agent subprocess management, `.tmp` orphan fix, post-run signal finalization. Eliminates manual cleanup between wet calibration iterations.
- `real-calibration-ingest.md` — **Real calibration ingest:** Parse `.maildump/` emails + CI results spreadsheet → cross-reference → select ≤30 diverse cases → annotate ground truth → generate `ptp_real_ingest.go` scenario for wet calibration with real data.
- `calibration-bugfix-r5.md` — **Calibration bugfix R5:** Fix 5 known blocking bugs from Round 4 (H15 false-duplicate, skip path, repo names, JSON error, component ID). Target: M19 >= 0.65.
- `responder-classification-v2.md` — **Responder classification v2:** Ground-truth test fixture, scored multi-signal classifier, token optimization. Target: M19 >= 0.80.
- `calibration-victory.md` — **Calibration victory:** Evidence quality, RCA relevance, convergence calibration, cross-scenario regression. Target: M19 >= 0.95, 20/20 metrics.
- `parallel-investigation.md` — **Parallel investigation:** Fan-out F0-F1, symptom clustering, on-demand RCA agents, token ceiling. Future phase. Target: >= 3x speedup.
- `token-perf-tracking.md` — **Token perf tracking:** Instrument real token usage per step/case/run; compute estimated USD cost; upgrade M18 from `steps*1000` to actual measurement; per-case and per-step breakdowns in calibration report.