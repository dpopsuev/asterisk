---
description: "DSL design principles for the Agentic Network Framework pipeline language"
globs: "internal/framework/**,pipelines/**"
---

# DSL Design Principles

Eight principles governing the design of pipeline definition files for the Agentic Network Framework. Rooted in Seymour Papert's "low floor, high ceiling" principle (MIT, 1970s) extended by Mitchel Resnick with "wide walls."

Core constraint: **reading is more important than writing.** Readers are both humans and AI agents. Writers are ~90% AI with ~10% human debugging/tuning.

## P1: YAML as Canonical Format

YAML is the source of truth. One file per pipeline. All other representations (Mermaid diagrams, Go structs, documentation) are derived from the YAML definition.

## P2: Declarative Intent, Not Procedural Steps

Declare what the pipeline IS (nodes, edges, zones), not how to run it. Edge conditions are natural-language labels in YAML; actual evaluation logic lives in Go `Edge.Evaluate()` functions registered via `NodeRegistry`.

## P3: Reading-First Layout

Optimize for scan-and-understand. Ordered top-down:

1. Pipeline name and description (what am I looking at?)
2. Zones (what are the major phases?)
3. Nodes (what are the processing stages?)
4. Edges (how do stages connect?)
5. Start and done markers

Edges are sorted by source node so a reader can follow the flow linearly.

## P4: One Concept Per Block

Each YAML block maps to exactly one Framework type: a node, an edge, a zone. No overloaded blocks that serve dual purposes. Both human and AI readers can grep/search for any concept by its block key.

## P5: Human Labels, Machine IDs

Every edge carries both an `id` (machine-stable, e.g. `H1`) and a `name` (human-readable, e.g. `recall-hit`). Conditions are natural-language descriptions in the YAML; the Go registry holds the executable logic.

## P6: Derived Visualization

A `Render(def *PipelineDef) string` function generates Mermaid from the YAML-parsed `PipelineDef`. Mermaid is never hand-written as pipeline source. This keeps visual and textual representations permanently in sync.

## P7: Progressive Disclosure

Basic pipelines need only `nodes`, `edges`, `start`, `done`. Advanced features are optional YAML keys with sensible defaults:

| Feature | YAML key | Default when absent |
|---------|----------|---------------------|
| Zones | `zones` | No zone grouping |
| Element affinity | `element` on node | Unaffiliated |
| Stickiness | `stickiness` on zone | 0 (no stickiness) |
| Cost profiles | `cost` on node | Zero-cost estimate |

Low floor: a 10-line pipeline file is valid. High ceiling: the full F0-F6 pipeline with zones, elements, and cost profiles is equally expressible.

## P8: Round-Trip Fidelity

`LoadPipeline(data) -> PipelineDef -> MarshalYAML(def) -> data'` must produce semantically equivalent YAML. No information loss in the cycle. This enables the AI-write, human-review, AI-read workflow.

## Format Decision Record

YAML was chosen over alternatives after assessing the dual-audience constraint:

| Format | Verdict | Rationale |
|--------|---------|-----------|
| **YAML** | Primary | Best LLM comprehension, excellent human readability, stable Go library (`gopkg.in/yaml.v3`) |
| **Mermaid** | Derived view | Great for topology visualization; lacks typed metadata, conditions, zone properties |
| **CUE** | Future ceiling extension | Type-safe but higher learning curve; violates low-floor principle for PoC |
| **HCL** | Rejected | Infrastructure-oriented; wrong domain fit |
| **Custom DSL** | Rejected | Requires building a parser; untested LLM comprehension; premature |

Type safety comes from Go's `PipelineDef.Validate()` and the `NodeRegistry` pattern (proven by Dagster's DSL approach). CUE can be adopted later without breaking the YAML surface.
