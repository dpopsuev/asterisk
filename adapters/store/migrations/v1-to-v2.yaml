from: 1
to: 2
operations:
  # Step 1: Rename v1 tables to backup
  - rename_table:
      from: cases
      to: _v1_cases
  - rename_table:
      from: rcas
      to: _v1_rcas
  - rename_table:
      from: envelopes
      to: _v1_envelopes

  # Step 2: Create all v2 Tier 1 tables
  - create_table:
      name: investigation_suites
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: name
          type: text
          not_null: true
        - name: description
          type: text
        - name: status
          type: text
          not_null: true
          default: "'open'"
        - name: created_at
          type: text
          not_null: true
        - name: closed_at
          type: text

  - create_table:
      name: versions
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: label
          type: text
          not_null: true
          unique: true
        - name: ocp_build
          type: text

  - create_table:
      name: circuits
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: suite_id
          type: integer
          not_null: true
          references: "investigation_suites(id)"
        - name: version_id
          type: integer
          not_null: true
          references: "versions(id)"
        - name: name
          type: text
          not_null: true
        - name: rp_launch_id
          type: integer
        - name: status
          type: text
          not_null: true
        - name: started_at
          type: text
        - name: ended_at
          type: text

  - create_table:
      name: launches
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: circuit_id
          type: integer
          not_null: true
          references: "circuits(id)"
        - name: rp_launch_id
          type: integer
          not_null: true
        - name: rp_launch_uuid
          type: text
        - name: name
          type: text
        - name: status
          type: text
        - name: started_at
          type: text
        - name: ended_at
          type: text
        - name: env_attributes
          type: text
        - name: git_branch
          type: text
        - name: git_commit
          type: text
        - name: envelope_payload
          type: blob
      unique:
        - [circuit_id, rp_launch_id]

  - create_table:
      name: jobs
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: launch_id
          type: integer
          not_null: true
          references: "launches(id)"
        - name: rp_item_id
          type: integer
          not_null: true
        - name: name
          type: text
          not_null: true
        - name: clock_type
          type: text
        - name: status
          type: text
        - name: stats_total
          type: integer
        - name: stats_failed
          type: integer
        - name: stats_passed
          type: integer
        - name: stats_skipped
          type: integer
        - name: started_at
          type: text
        - name: ended_at
          type: text
      unique:
        - [launch_id, rp_item_id]

  - create_table:
      name: cases
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: job_id
          type: integer
          not_null: true
          references: "jobs(id)"
        - name: launch_id
          type: integer
          not_null: true
          references: "launches(id)"
        - name: rp_item_id
          type: integer
          not_null: true
        - name: name
          type: text
          not_null: true
          default: "''"
        - name: polarion_id
          type: text
        - name: status
          type: text
          not_null: true
          default: "'open'"
        - name: symptom_id
          type: integer
          references: "symptoms(id)"
        - name: rca_id
          type: integer
          references: "rcas(id)"
        - name: error_message
          type: text
        - name: log_snippet
          type: text
        - name: log_truncated
          type: integer
          default: "0"
        - name: started_at
          type: text
        - name: ended_at
          type: text
        - name: created_at
          type: text
          not_null: true
        - name: updated_at
          type: text
          not_null: true
      unique:
        - [launch_id, rp_item_id]

  - create_table:
      name: triages
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: case_id
          type: integer
          not_null: true
          unique: true
          references: "cases(id)"
        - name: symptom_category
          type: text
          not_null: true
        - name: severity
          type: text
        - name: defect_type_hypothesis
          type: text
        - name: skip_investigation
          type: integer
          default: "0"
        - name: clock_skew_suspected
          type: integer
          default: "0"
        - name: cascade_suspected
          type: integer
          default: "0"
        - name: candidate_repos
          type: text
        - name: data_quality_notes
          type: text
        - name: created_at
          type: text
          not_null: true

  # Tier 2: Global knowledge
  - create_table:
      name: symptoms
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: fingerprint
          type: text
          not_null: true
          unique: true
        - name: name
          type: text
          not_null: true
        - name: description
          type: text
        - name: error_pattern
          type: text
        - name: test_name_pattern
          type: text
        - name: component
          type: text
        - name: severity
          type: text
        - name: first_seen_at
          type: text
          not_null: true
        - name: last_seen_at
          type: text
          not_null: true
        - name: occurrence_count
          type: integer
          not_null: true
          default: "1"
        - name: status
          type: text
          not_null: true
          default: "'active'"

  - create_table:
      name: rcas
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: title
          type: text
          not_null: true
        - name: description
          type: text
          not_null: true
          default: "''"
        - name: defect_type
          type: text
          not_null: true
        - name: category
          type: text
        - name: component
          type: text
        - name: affected_versions
          type: text
        - name: evidence_refs
          type: text
        - name: convergence_score
          type: real
        - name: jira_ticket_id
          type: text
        - name: jira_link
          type: text
        - name: status
          type: text
          not_null: true
          default: "'open'"
        - name: created_at
          type: text
          not_null: true
        - name: resolved_at
          type: text
        - name: verified_at
          type: text
        - name: archived_at
          type: text

  - create_table:
      name: symptom_rca
      columns:
        - name: id
          type: integer
          primary_key: true
          autoincrement: true
        - name: symptom_id
          type: integer
          not_null: true
          references: "symptoms(id)"
        - name: rca_id
          type: integer
          not_null: true
          references: "rcas(id)"
        - name: confidence
          type: real
        - name: notes
          type: text
        - name: linked_at
          type: text
          not_null: true
      unique:
        - [symptom_id, rca_id]

  # Step 3: Seed migration data
  - raw_sql: >-
      INSERT INTO investigation_suites(name, description, status, created_at)
      VALUES('Migrated from v1', 'Auto-created during v1-to-v2 migration', 'open', datetime('now'))
  - raw_sql: >-
      INSERT INTO versions(label) VALUES('unknown')

  # Step 4: Migrate envelopes â†’ circuits + launches
  - raw_sql: >-
      INSERT INTO circuits(suite_id, version_id, name, rp_launch_id, status)
      SELECT 1, 1, 'migrated-circuit-' || e.launch_id, e.launch_id, 'UNKNOWN'
      FROM _v1_envelopes e
  - raw_sql: >-
      INSERT INTO launches(circuit_id, rp_launch_id, envelope_payload)
      SELECT p.id, p.rp_launch_id, e.payload
      FROM _v1_envelopes e
      JOIN circuits p ON p.rp_launch_id = e.launch_id

  # Step 5: Create placeholder jobs
  - raw_sql: >-
      INSERT INTO jobs(launch_id, rp_item_id, name)
      SELECT l.id, 0, 'migrated-job' FROM launches l

  # Step 6: Migrate v1 rcas
  - raw_sql: >-
      INSERT INTO rcas(title, description, defect_type, jira_ticket_id, jira_link, status, created_at)
      SELECT title, description, defect_type, jira_ticket_id, jira_link, 'open', datetime('now')
      FROM _v1_rcas

  # Step 7: Migrate v1 cases
  - raw_sql: >-
      INSERT INTO cases(job_id, launch_id, rp_item_id, name, status, rca_id, created_at, updated_at)
      SELECT j.id, l.id, oc.item_id, '', 'open',
      CASE WHEN oc.rca_id IS NOT NULL THEN oc.rca_id ELSE NULL END,
      datetime('now'), datetime('now')
      FROM _v1_cases oc
      JOIN launches l ON l.rp_launch_id = oc.launch_id
      JOIN jobs j ON j.launch_id = l.id

  # Step 8: Create indexes
  - create_index:
      name: idx_cases_symptom
      table: cases
      columns: [symptom_id]
  - create_index:
      name: idx_cases_rca
      table: cases
      columns: [rca_id]
  - create_index:
      name: idx_cases_launch
      table: cases
      columns: [launch_id]
  - create_index:
      name: idx_cases_job
      table: cases
      columns: [job_id]
  - create_index:
      name: idx_circuits_suite
      table: circuits
      columns: [suite_id]
  - create_index:
      name: idx_launches_circuit
      table: launches
      columns: [circuit_id]
  - create_index:
      name: idx_jobs_launch
      table: jobs
      columns: [launch_id]
  - create_index:
      name: idx_symptoms_fingerprint
      table: symptoms
      columns: [fingerprint]
  - create_index:
      name: idx_symptom_rca_symptom
      table: symptom_rca
      columns: [symptom_id]
  - create_index:
      name: idx_symptom_rca_rca
      table: symptom_rca
      columns: [rca_id]
