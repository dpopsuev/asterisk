# F0-F6 Root Cause Analysis pipeline.
# Source of truth for the RCA graph structure.
# Edge routing uses when: expressions evaluated by expr-lang/expr.
pipeline: rca-investigation
description: "F0-F6 root cause analysis pipeline"

vars:
  recall_hit: 0.80
  recall_uncertain: 0.40
  convergence_sufficient: 0.70
  max_investigate_loops: 2
  correlate_dup: 0.80

zones:
  backcourt:
    nodes: [recall, triage]
    element: fire
    stickiness: 0
  frontcourt:
    nodes: [resolve, investigate]
    element: water
    stickiness: 3
  paint:
    nodes: [correlate, review, report]
    element: air
    stickiness: 1

nodes:
  - name: recall
    element: fire
    family: recall
  - name: triage
    element: fire
    family: triage
  - name: resolve
    element: earth
    family: resolve
  - name: investigate
    element: water
    family: investigate
  - name: correlate
    element: air
    family: correlate
  - name: review
    element: diamond
    family: review
  - name: report
    element: air
    family: report

edges:
  - id: H1
    name: recall-hit
    from: recall
    to: review
    shortcut: true
    when: 'output.match == true && output.confidence >= config.recall_hit'

  - id: H3
    name: recall-uncertain
    from: recall
    to: triage
    when: 'output.match == true && output.confidence >= config.recall_uncertain && output.confidence < config.recall_hit'

  - id: H2
    name: recall-miss
    from: recall
    to: triage
    when: 'output.match != true'

  - id: H4
    name: triage-skip-infra
    from: triage
    to: review
    shortcut: true
    when: 'output.symptom_category == "infra"'

  - id: H5
    name: triage-skip-flake
    from: triage
    to: review
    shortcut: true
    when: 'output.symptom_category == "flake"'

  - id: H18
    name: triage-skip-investigation
    from: triage
    to: review
    shortcut: true
    when: 'output.skip_investigation == true'

  - id: H7
    name: triage-single-repo
    from: triage
    to: investigate
    shortcut: true
    when: 'output.skip_investigation != true && len(output.candidate_repos) == 1'

  - id: H6
    name: triage-investigate
    from: triage
    to: resolve
    when: 'output.skip_investigation != true'

  - id: H8
    name: resolve-proceed
    from: resolve
    to: investigate
    when: 'true'

  - id: H9
    name: investigate-converged
    from: investigate
    to: correlate
    when: 'output.convergence_score >= config.convergence_sufficient'

  - id: H10a
    name: investigate-no-evidence-skip
    from: investigate
    to: correlate
    when: 'output.convergence_score < config.convergence_sufficient && len(output.evidence_refs) == 0'

  - id: H10
    name: investigate-loop
    from: investigate
    to: resolve
    loop: true
    when: 'output.convergence_score < config.convergence_sufficient && len(output.evidence_refs) > 0 && state.loops.investigate < config.max_investigate_loops'

  - id: H11
    name: investigate-exhausted
    from: investigate
    to: review
    when: 'output.convergence_score < config.convergence_sufficient && state.loops.investigate >= config.max_investigate_loops'

  - id: H15
    name: correlate-dup
    from: correlate
    to: _done
    shortcut: true
    when: 'output.is_duplicate == true && output.confidence >= config.correlate_dup'

  - id: H15b
    name: correlate-proceed
    from: correlate
    to: review
    when: 'true'

  - id: H12
    name: review-approve
    from: review
    to: report
    when: 'output.decision == "approve"'

  - id: H13
    name: review-reassess
    from: review
    to: resolve
    loop: true
    when: 'output.decision == "reassess"'

  - id: H14
    name: review-overturn
    from: review
    to: report
    when: 'output.decision == "overturn"'

  - id: H16
    name: report-done
    from: report
    to: _done
    when: 'true'

start: recall
done: _done
